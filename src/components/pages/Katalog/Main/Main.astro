---
import { getByUID, getPage } from "@/prismic";
import KatalogMain from "./Main";

import PDFIcon from "@assets/ic-pdf.svg?raw";

const { list_category: list } = Astro.props.data;

const homeData = await getPage("home")
const homeKustomerList = await Promise.all(
    homeData.data.industry_list.map((industry: any) => {
        let item = getByUID("industry", industry.item.uid);
        return item;
    }),
);
const kustomerList = homeKustomerList.map(({ data, uid }) =>
	({ title: data.title, uid: uid })
);

let listUidCate = [];
await list
	.reduce((acc, curr) => acc.concat(curr.item.uid), [])
	.map((el) => {
		!listUidCate.includes(el) && listUidCate.push(el);
	});

let listCate = await Promise.all(
	listUidCate.map((el: any) => {
		const item = getByUID("product_group", el);
		return item;
	}),
);
const homeCategoryList = await Promise.all(
    homeData.data.product_kategory_list.map((category: any) => {
        let item = getByUID("product_group", category.item.uid);
        return item;
    }),
);

const getProductByCategory = await Promise.all(
	homeCategoryList
		.reduce((acc, curr) => acc.concat({ list: curr.data.product_list, name: curr.data.name }), [])
		.map(async (data: any) => ({
			...data,
			list: await Promise.all(
				data.list.map(async (el: any) => {
					if (el.product.uid) {
						return await getByUID("product", el.product.uid).then((item) =>
							({ ...item, category: data.name }));
					}
					return null;
				})
			).then(list => list.filter(item => item !== null))
		}))
)
const allItem = getProductByCategory.reduce((acc, curr) => acc.concat(curr.list), [])
const cateList = homeCategoryList.map(({ data }) => data.name)
---
<KatalogMain
	kustomerList={kustomerList}
	cateList={cateList}
	allItem={allItem}
	client:visible={{ rootMargin: "100% 0% 100% 0%" }}
>
	<Fragment set:html={PDFIcon} slot="PDFIcon" />
</KatalogMain>
